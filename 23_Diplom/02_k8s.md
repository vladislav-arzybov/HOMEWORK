### Создание Kubernetes кластера

На этом этапе необходимо создать [Kubernetes](https://kubernetes.io/ru/docs/concepts/overview/what-is-kubernetes/) кластер на базе предварительно созданной инфраструктуры.   Требуется обеспечить доступ к ресурсам из Интернета.

Это можно сделать двумя способами:

1. Рекомендуемый вариант: самостоятельная установка Kubernetes кластера.  
   а. При помощи Terraform подготовить как минимум 3 виртуальных машины Compute Cloud для создания Kubernetes-кластера. Тип виртуальной машины следует выбрать самостоятельно с учётом требовании к производительности и стоимости. Если в дальнейшем поймете, что необходимо сменить тип инстанса, используйте Terraform для внесения изменений.  
   б. Подготовить [ansible](https://www.ansible.com/) конфигурации, можно воспользоваться, например [Kubespray](https://kubernetes.io/docs/setup/production-environment/tools/kubespray/)  
   в. Задеплоить Kubernetes на подготовленные ранее инстансы, в случае нехватки каких-либо ресурсов вы всегда можете создать их при помощи Terraform.
2. Альтернативный вариант: воспользуйтесь сервисом [Yandex Managed Service for Kubernetes](https://cloud.yandex.ru/services/managed-kubernetes)  
  а. С помощью terraform resource для [kubernetes](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/kubernetes_cluster) создать **региональный** мастер kubernetes с размещением нод в разных 3 подсетях      
  б. С помощью terraform resource для [kubernetes node group](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/kubernetes_node_group)
  
Ожидаемый результат:

1. Работоспособный Kubernetes кластер.
2. В файле `~/.kube/config` находятся данные для доступа к кластеру.
3. Команда `kubectl get pods --all-namespaces` отрабатывает без ошибок.


### РЕШЕНИЕ:
> Запуск с локального хоста на мастер ноде, прокидывание приватного ключа:
- ansible-playbook -i ansible/inventory/inventory.ini ansible/site.yaml

> Обновить TLS-сертификат Kubernetes API-сервера и включить в него внешний IP-адрес моего хоста
- Правим: inventory/<your_cluster>/group_vars/k8s_cluster/k8s-cluster.yml, строку:

```
supplementary_addresses_in_ssl_keys:
  - 89.169.135.188
```

- ansible-playbook -i inventory/mycluster/inventory.ini   --become --become-user=root   cluster.yml   -t "k8s-certificates"

- Повторно копируем конфиг и выдаем права:

```bash
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

> Копирование конфига k8s на локальный хост
- scp reivol@89.169.135.188:/home/reivol/.kube/config /home/reivol/.kube/
- В конфиге /home/reivol/.kube/config, правим: server: https://127.0.0.1:6443, на server: https://89.169.135.188:6443 (внещний ip master-node)
- Проверяем: kubectl get pods --all-namespaces
